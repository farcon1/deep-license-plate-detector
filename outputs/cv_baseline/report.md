# Classical CV baseline: запуск, оценка и интерпретация

Я использую classical CV baseline как нижнюю границу качества для задачи детекции/локализации номерных знаков. Его роль - не "победить" нейросети, а:
- зафиксировать минимально разумный ориентир качества;
- получить набор “типовых ошибок” и затем использовать его как аргументацию необходимости DL-подхода.

---

## 1. Что именно делает baseline
В каждом изображении baseline пытается найти **один** прямоугольник номерного знака:
1) grayscale + CLAHE (выравнивание контраста);
2) SobelX (усиление вертикальных границ - символы номера дают такие границы);
3) бинаризация (Otsu);
4) морфология (close/open), чтобы склеить номер в единый регион;
5) поиск контуров, генерация кандидатов bbox;
6) скоринг кандидатов (rectangularity + близость aspect ratio к целевому + edge density);
7) выбор лучшего bbox и возврат score в диапазоне 0-1.

---

## 2. Как я запускаю baseline
Команды я выполняю из корня проекта 
```cmd
python scripts/run_cv_baseline.py --config config.yaml
```

---

## 3. Протокол оценки

Я оцениваю задачу в постановке "один объект на изображение":

* на каждом изображении есть **ровно один GT bbox**, который восстанавливается из имени файла CCPD;
* baseline возвращает **один pred bbox** либо ничего.

Считаю:

* **IoU** между GT и pred bbox;
* **success rate**: доля изображений, где IoU >= порога;
* **PR-кривую по score**: при пороге `score >= t` определяю:

  * TP: `IoU >= iou_thr` и `score >= t`
  * FP: `IoU < iou_thr` и `score >= t`
  * FN: `N - TP` (так как в каждом изображении ровно один GT)

Важно: в этой постановке максимальный recall ограничен долей изображений, где детектор в принципе способен дать IoU выше порога (то есть success rate).

---

## 4. Результаты baseline

### 4.1 Покрытие и техническая корректность

Я обработал **199 996** изображений CCPD Base.

* Детектор почти всегда возвращает bbox:

  * `pred_rate = 0.99124` - предсказание получено для **99.12%** изображений
  * `n_no_candidates = 1752` - **0.88%** изображений без кандидатов (после фильтрации эвристиками)

* Средняя уверенность на изображениях с предсказанием:

  * `mean_score_pred_only = 0.5673`

### 4.2 Распределение IoU

Сводная статистика IoU по всем изображениям:

* **mean IoU = 0.1953**
* **median IoU = 0.0**

Нулевая медиана означает, что более чем в половине случаев выбранный прямоугольник **практически не пересекается** с истинным номером. Гистограмма IoU имеет выраженный пик около 0 и отдельный "остров" в области высоких IoU (примерно 0.7–0.9), что соответствует редким успешным попаданиям.

### 4.3 Success rate по порогам IoU

**IoU >= 0.50**

* `success_rate = 0.2409` - **24.09%** (48 180 изображений)

**IoU >= 0.70**

* `success_rate = 0.1823` - **18.23%** (36 458 изображений)

Я интерпретирую это как долю сцен, где классические контурные эвристики способны локализовать номер удовлетворительно (0.50) и достаточно точно (0.70).

---

## 5. PR-кривые, AP и рабочие точки

### 5.1 IoU >= 0.50

* **AP = 0.07528**
* Лучшая точка по F1 достигается при `score_thr = 0.49`:

  * **best F1 = 0.2461**
  * **Precision = 0.2653**
  * **Recall = 0.2296**

Практически это означает, что при настройке порога на максимум F1 среди принятых детекций только около 26.5% являются корректными (в смысле IoU ≥ 0.5), при полноте около 23%.

Максимальный recall на PR-кривой = 0.2409, что совпадает с success rate при IoU >= 0.50.

### 5.2 IoU >= 0.70

* **AP = 0.04786**
* Лучшая точка по F1 при `score_thr = 0.52`:

  * **best F1 = 0.1896**
  * **Precision = 0.2203**
  * **Recall = 0.1665**

При строгом IoU >= 0.70 качество падает, потому что baseline часто даёт бокс со смещением и/или неверным масштабом и не проходит строгий критерий пересечения.

---

## 6. Итоговая интерпретация baseline

По результатам я фиксирую два устойчивых режима:

1. **Массовые промахи (IoU=0):** алгоритм выбирает ложные прямоугольники на текстурах кузова, бликах, решётках, фоновых структурах. Эвристик "контуры + морфология + aspect ratio" недостаточно для надёжного отделения номера от визуально похожих паттернов.
2. **Редкие удачи (IoU=0.7–0.9):** при хорошем контрасте, умеренной перспективе и относительно чистом фоне метод действительно попадает в номер и даёт адекватную локализацию.

Ключевое ограничение — нестабильность выбора правильного кандидата, из-за чего:

* **success rate** ограничен 24% (IoU>=0.5) и 18% (IoU>=0.7);
* **AP** низкий, то есть score слабо разделяет успешные и неуспешные случаи.

---

## 7. Вывод и следующий шаг

Я зафиксировал baseline-уровень качества на CCPD Base:

* **IoU >= 0.50:** success rate **24.09%**
* **IoU >= 0.70:** success rate **18.23%**
* **AP:** 0.075 (IoU>=0.5) и 0.048 (IoU>=0.7)

Эти результаты дают формальную нижнюю границу и обоснование перехода к нейросетевым детекторам (например, YOLO/Faster R-CNN), которые должны существенно улучшить полноту и устойчивость к вариативности сцен (перспектива, низкая освещённость, blur и сложный фон).
